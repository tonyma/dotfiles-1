#!/bin/zsh

[ -f /usr/local/var/userjob-log.log ] && rm -f /usr/local/var/userjob-log.log
[ -f /etc/zshenv ] && source /etc/zshenv
source ${HOME}/.config/zsh/.zshenv

error=""

# Bundle brew:
if [ -x /usr/local/bin/brew ]; then
  /usr/local/bin/brew bundle dump --force --file=${HOME}/.config/homebrew/bundle --describe || error="1"
else
  echo no brew >&2
fi

# dump pacman
if [ -x /usr/bin/pacman ]; then
  /usr/bin/pacman -Qe > ${HOME}/.config/pacman/dump.txt || error="1"
else
  echo no pacman >&2
fi

if [[ -n ${error} ]]; then
  if command -v osascript >/dev/null 2>&1 ; then
    echo "var app = Application('System Events');
  app.includeStandardAdditions = true;
  var reply = app.displayDialog('Failed to process scheduled task', {
    'withTitle': 'User Job',
    'withIcon':'caution',

    'givingUpAfter': 15,

    'defaultButton': 'OK',
    'buttons': ['Details', 'OK']
  });

  if (reply.buttonReturned === 'Details') {
    var textEdit = Application('TextEdit');
    textEdit.open('/usr/local/var/userjob-err.log');
  }
  " \
      | osascript -l JavaScript -
  fi
fi
